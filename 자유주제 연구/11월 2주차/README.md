# Optical Flow
Optical Flow(광학 흐름)은 카메라 또는 물체의 이동에 의해 생기는 연속된 2개의 이미지 간의 어떤 이동에 대한 패턴이다. 
영상은 시간순으로 나열된 2차원 이미지들의 조합인데, 연속된 2개의 이미지 차이를 통해 영상에 존재하는 물체의 움직임을 추정할 수 있다.

Optical Flow를 적용하기 위해서는 
"영상에서 연속하는 두 프레임 간의 관심 픽셀의 밝기값은 변함이 없다." 
라는 전제가 필요하다. 

위 전제가 만족한다면, 영상에서 특정 t프레임의 관심 픽셀(x,y)의 밝기값 I(x,y,t)는 연속하는 다음 프레임에서 위치만 변하고, 
밝기값은 그대로 유지될 것이다. 따라서 다음과 같은 식이 성립한다. 

![image](https://user-images.githubusercontent.com/49221790/99050701-87b84c80-25db-11eb-8830-53a136f91ba9.png)

(1) 식의 우항을 테일러 급수 전개를 하면,  

![image](https://user-images.githubusercontent.com/49221790/99050962-9acb1c80-25db-11eb-9309-50225372bccc.png)


가 된다. 이 때, (1)과 (2)가 동시에 성립하려면, (2)에 있는 미분식의 합이 0이여야 한다. 즉, 다음과 같은 식이 성립한다.

![image](https://user-images.githubusercontent.com/49221790/99051113-a61e4800-25db-11eb-8226-9242f3ba48af.png)

식 (3)을 다시 정리하면 아래와 같다.

![image](https://user-images.githubusercontent.com/49221790/99051277-b2a2a080-25db-11eb-8c1a-e59a63857b98.png)

ax(거리)/at(시간)은 결국, x와 y방향으로의 각각 움직임의 속도를 가리킨다.  
또한 aI/ax, aI/ay, aI/at는 각각 이미지 I에 대한 x방향, y방향의 편미분 Ix, Iy, It이다.  
마지막으로, 식(4)를 간추리면 다음과 같이 쓸 수 있다.

![image](https://user-images.githubusercontent.com/49221790/99051428-bfbf8f80-25db-11eb-9bae-d3872c2e6834.png)

매트릭스 식으로 나타내면 아래와 같이 쓸 수 있다.

![image](https://user-images.githubusercontent.com/49221790/99059415-e7b1f180-25e1-11eb-8690-66e6b397f927.png)

Motion Vector (Vx, Vy)를 구하는데있어서, 영상을 x축으로 미분(Ix)하고, y축으로 미분(Iy)하고, 시간축으로 미분(It)해서 저 식에 대입해서 Matrix를 풀면 바로 구할 수 있다.  
여기서 Ix, Iy, It는 matrix가 맞지만 Vx, Vy는 matrix가 아니므로 이것에만 대입하면 전체 이미지에 대한 모션 벡터가 단 하나만 나온다.  

각 부분에 대한 모션 벡터를 찾기 위해서는 다른 방법을 써야되는데, 그나마 간단한 방법으로는 OpenCV에서 Lucas-Kanade 라는 API로 제공하고 있다.  
Lucas-kanade의 특징으로는 sparse optical flow로 특징점을 찾아 그 특징점의 모션 벡터를 찾아내어 표시한다.

API를 적용해 보았을 때  
![image](https://user-images.githubusercontent.com/49221790/99057870-b46e6300-25df-11eb-8c6b-2c759b4d0ceb.png)  

움직임에 따라 선이 생기는 것을 확인할 수 있었다.  

![image](https://user-images.githubusercontent.com/49221790/99057626-69545000-25df-11eb-85ae-c7668cd61392.png)  

배경이 함께 움직이는 경우 배경도 관심 픽셀로 잡혀서 매우 난잡해진다.

Lucas-Kanade 방식으로는 모션이 크면 잘 안되고 움직임이 느려야 잘 된다는 등 단점이 좀 많아서, 최근에 나온 방법으로는 PWC-net이 있다.  
다음주는 이거 해봐야지..  

이제 스켈레톤 정보만 관심픽셀에 넣고 관절마다 나오는 모션 벡터를 어떻게 처리할까가 문제인데,  
이상행동의 동영상에서 나오는 벡터값을 추출해서 이거 하면 이상한거야 라고 해야될지  
아니면 앞발로 귀를 긁었다 라는 행동을 벡터값의 연속으로 나타낼 수 있을지..  
일단 스켈레톤 정보 넣는 것도 뭔가 잘 안 되어서 시멘틱 분할로 몸 부위를 나눌 수 있을지 고민중이다.
시멘틱 분할이면 툴도 구하기 쉬운데..  

-------
#### 테일러 급수가 뭐지?
(위키백과) 미적분학에서, 테일러 급수(Taylor級數, 영어: Taylor series)는 도함수들의 한 점에서의 값으로 계산된 항의 무한합으로 해석함수를 나타내는 방법이다. ~?????~  
미분 가능한 함수 f(x)에 대해 x = a에서 f(x)에 접하는 다항 함수로 표현하는 방법.. 멱급수에서 파생된다고 한다.  

#### sparse optical flow
추적할 점들의 일부를 미리 지정해주고 추적하는 방법.  
실제 응용에서 주로 활용 (연산량이 적으며 속도가 빠르다)  
반대로는 dense optical flow가 있으며 영상 내부의 모든 픽셀에서 속도를 구하는 방법이다.  
학계에서 연구목적으로 주로 사용된다.
